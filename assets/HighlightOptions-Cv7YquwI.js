import{bU as lt,U as mt,e as I,y as B,a as ht,W as at,u as dt,c5 as G,j4 as gt,Q as pt,kL as yt,kM as _t,cw as U}from"./index-DMEurr7E.js";import{e as E}from"./TileKey-BFS45xI_.js";import{m as vt,b as et}from"./vec2-RO8L90HL.js";import{_ as xt}from"./QueueProcessor-Cq9PfO1X.js";import{f as wt}from"./quickselect-D0_cvEX6.js";function Y(o,t){return[o,t]}function k(o,t,e){return o[0]=t,o[1]=e,o}function It(o,t,e,i,s){return o[0]=t,o[1]=e,o[2]=i,o[3]=s,o}const M=new E("0/0/0/0");let Mt=class ct{static create(t,e,i=null){const s=lt(t.spatialReference),r=e.origin||Y(t.origin.x,t.origin.y),n=Y(t.size[0]*e.resolution,t.size[1]*e.resolution),l=Y(-1/0,-1/0),h=Y(1/0,1/0),a=Y(1/0,1/0);i!=null&&(k(l,Math.max(0,Math.floor((i.xmin-r[0])/n[0])),Math.max(0,Math.floor((r[1]-i.ymax)/n[1]))),k(h,Math.max(0,Math.floor((i.xmax-r[0])/n[0])),Math.max(0,Math.floor((r[1]-i.ymin)/n[1]))),k(a,h[0]-l[0]+1,h[1]-l[1]+1));const{cols:c,rows:u}=e;let f,g,v,p;return!i&&c&&u&&(k(l,c[0],u[0]),k(h,c[1],u[1]),k(a,c[1]-c[0]+1,u[1]-u[0]+1)),t.isWrappable?(f=Y(Math.ceil(Math.round((s.valid[1]-s.valid[0])/e.resolution)/t.size[0]),a[1]),g=Y(Math.floor((s.origin[0]-r[0])/n[0]),l[1]),v=Y(f[0]+g[0]-1,h[1]),p=!0):(g=l,v=h,f=a,p=!1),new ct(e.level,e.resolution,e.scale,r,l,h,a,n,g,v,f,p)}constructor(t,e,i,s,r,n,l,h,a,c,u,f){this.level=t,this.resolution=e,this.scale=i,this.origin=s,this.first=r,this.last=n,this.size=l,this.norm=h,this.worldStart=a,this.worldEnd=c,this.worldSize=u,this.wrap=f}normalizeCol(t){if(!this.wrap)return t;const e=this.worldSize[0];return t<0?e-1-Math.abs((t+1)%e):t%e}denormalizeCol(t,e){return this.wrap?this.worldSize[0]*e+t:t}getWorldForColumn(t){return this.wrap?Math.floor(t/this.worldSize[0]):0}getFirstColumnForWorld(t){return t*this.worldSize[0]+this.first[0]}getLastColumnForWorld(t){return t*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(t){return(t-this.origin[0])/this.norm[0]}getXForColumn(t){return this.origin[0]+t*this.norm[0]}getRowForY(t){return(this.origin[1]-t)/this.norm[1]}getYForRow(t){return this.origin[1]-t*this.norm[1]}getTileBounds(t,e,i=!1){M.set(e);const s=i?M.col:this.denormalizeCol(M.col,M.world),r=M.row;return It(t,this.getXForColumn(s),this.getYForRow(r+1),this.getXForColumn(s+1),this.getYForRow(r)),t}getTileCoords(t,e,i=!1){M.set(e);const s=i?M.col:this.denormalizeCol(M.col,M.world);return Array.isArray(t)?k(t,this.getXForColumn(s),this.getYForRow(M.row)):(t.x=this.getXForColumn(s),t.y=this.getYForRow(M.row)),t}},D=class{constructor(){this.spans=[]}acquire(t){this.lodInfo=t}release(){this.lodInfo=null,this.spans.length=0}*keys(){const t=this.lodInfo;for(const{row:e,colFrom:i,colTo:s}of this.spans)for(let r=i;r<=s;r++){const n=t.getWorldForColumn(r);yield new E(t.level,e,t.normalizeCol(r),n)}}forEach(t,e){const{spans:i,lodInfo:s}=this,{level:r}=s;if(i.length!==0)for(const{row:n,colFrom:l,colTo:h}of i)for(let a=l;a<=h;a++)t.call(e,r,n,s.normalizeCol(a),s.getWorldForColumn(a))}};D.pool=new mt(D);let K=class{constructor(t,e,i){this.row=t,this.colFrom=e,this.colTo=i}};const d=new E("0/0/0/0");let Bt=class ut{static create(t,e){t[1]>e[1]&&([t,e]=[e,t]);const[i,s]=t,[r,n]=e,l=r-i,h=n-s,a=h!==0?l/h:0,c=(Math.ceil(s)-s)*a,u=(Math.floor(s)-s)*a;return new ut(i,Math.floor(s),Math.ceil(n),a,l<0?c:u,l<0?u:c,l<0?r:i,l<0?i:r)}constructor(t,e,i,s,r,n,l,h){this.x=t,this.ymin=e,this.ymax=i,this.invM=s,this.leftAdjust=r,this.rightAdjust=n,this.leftBound=l,this.rightBound=h}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const w=[[0,0],[0,0],[0,0],[0,0]],St=1e-6;let Ot=class{constructor(t,e=null,i=t.lods[0].level,s=t.lods[t.lods.length-1].level){this.tileInfo=t,this.fullExtent=e,this.scales=[],this._infoByScale={},this._infoByLevel={};const r=t.lods.filter(l=>l.level>=i&&l.level<=s);this.minScale=r[0].scale,this.maxScale=r[r.length-1].scale;const n=this._lodInfos=r.map(l=>Mt.create(t,l,e));r.forEach((l,h)=>{this._infoByLevel[l.level]=n[h],this._infoByScale[l.scale]=n[h],this.scales[h]=l.scale},this),this._wrap=t.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(t){return this._infoByLevel[typeof t=="number"?t:t.level]}getTileBounds(t,e,i=!1){d.set(e);const s=this._infoByLevel[d.level];return s?s.getTileBounds(t,d,i):t}getTileCoords(t,e,i=!1){d.set(e);const s=this._infoByLevel[d.level];return s?s.getTileCoords(t,d,i):t}getTileCoverage(t,e=192,i=!0,s="closest"){if(!i&&(t.scale>this.minScale||t.scale<this.maxScale))return null;const r=s==="closest"?this.getClosestInfoForScale(t.scale):this.getSmallestInfoForScale(t.scale),n=D.pool.acquire(r),l=this._wrap;let h,a,c,u=1/0,f=-1/0;const g=n.spans;w[0][0]=w[0][1]=w[1][1]=w[3][0]=-e,w[1][0]=w[2][0]=t.size[0]+e,w[2][1]=w[3][1]=t.size[1]+e;for(const m of w)t.toMap(m,m),m[0]=r.getColumnForX(m[0]),m[1]=r.getRowForY(m[1]);const v=[];let p=3;for(let m=0;m<4;m++){if(w[m][1]===w[p][1]){p=m;continue}const y=Bt.create(w[m],w[p]);u=Math.min(y.ymin,u),f=Math.max(y.ymax,f),v[y.ymin]===void 0&&(v[y.ymin]=[]),v[y.ymin].push(y),p=m}if(u==null||f==null||f-u>100)return null;let x=[];for(h=u;h<f;){v[h]!=null&&(x=x.concat(v[h])),a=1/0,c=-1/0;for(let m=x.length-1;m>=0;m--){const y=x[m];a=Math.min(a,y.getLeftCol()),c=Math.max(c,y.getRightCol())}if(a=Math.floor(a),c=Math.floor(c),h>=r.first[1]&&h<=r.last[1])if(l)if(r.size[0]<r.worldSize[0]){const m=Math.floor(c/r.worldSize[0]);for(let y=Math.floor(a/r.worldSize[0]);y<=m;y++)g.push(new K(h,Math.max(r.getFirstColumnForWorld(y),a),Math.min(r.getLastColumnForWorld(y),c)))}else g.push(new K(h,a,c));else a>r.last[0]||c<r.first[0]||(a=Math.max(a,r.first[0]),c=Math.min(c,r.last[0]),g.push(new K(h,a,c)));h+=1;for(let m=x.length-1;m>=0;m--){const y=x[m];y.ymax>=h?y.incrRow():x.splice(m,1)}}return n}getTileParentId(t){d.set(t);const e=this._infoByLevel[d.level],i=this._lodInfos.indexOf(e)-1;return i<0?null:(this._getTileIdAtLOD(d,this._lodInfos[i],d),d.id)}getTileResolution(t){const e=this._infoByLevel[typeof t=="object"?t.level:t];return e?e.resolution:-1}getTileScale(t){const e=this._infoByLevel[t.level];return e?e.scale:-1}intersects(t,e){d.set(e);const i=this._infoByLevel[d.level],s=t.lodInfo;if(s.resolution>i.resolution){this._getTileIdAtLOD(d,s,d);const n=s.denormalizeCol(d.col,d.world);for(const l of t.spans)if(l.row===d.row&&l.colFrom<=n&&l.colTo>=n)return!0}if(s.resolution<i.resolution){const[n,l,h,a]=t.spans.reduce((p,x)=>(p[0]=Math.min(p[0],x.row),p[1]=Math.max(p[1],x.row),p[2]=Math.min(p[2],x.colFrom),p[3]=Math.max(p[3],x.colTo),p),[1/0,-1/0,1/0,-1/0]),c=i.denormalizeCol(d.col,d.world),u=s.getColumnForX(i.getXForColumn(c)),f=s.getRowForY(i.getYForRow(d.row)),g=s.getColumnForX(i.getXForColumn(c+1))-1,v=s.getRowForY(i.getYForRow(d.row+1))-1;return!(u>a||g<h||f>l||v<n)}const r=s.denormalizeCol(d.col,d.world);return t.spans.some(n=>n.row===d.row&&n.colFrom<=r&&n.colTo>=r)}normalizeBounds(t,e,i){if(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._wrap){const s=lt(this.tileInfo.spatialReference),r=-i*(s.valid[1]-s.valid[0]);t[0]+=r,t[2]+=r}return t}getSmallestInfoForScale(t){const e=this.scales;if(this._infoByScale[t])return this._infoByScale[t];if(t>e[0])return this._infoByScale[e[0]];for(let i=1;i<e.length-1;i++)if(t>e[i]+St)return this._infoByScale[e[i-1]];return this._infoByScale[e[e.length-1]]}getClosestInfoForScale(t){const e=this.scales;return this._infoByScale[t]||(t=e.reduce((i,s)=>Math.abs(s-t)<Math.abs(i-t)?s:i,e[0])),this._infoByScale[t]}scaleToLevel(t){const e=this.scales;if(this._infoByScale[t])return this._infoByScale[t].level;for(let i=e.length-1;i>=0;i--)if(t<e[i])return i===e.length-1?this._infoByScale[e[e.length-1]].level:this._infoByScale[e[i]].level+(e[i]-t)/(e[i]-e[i+1]);return this._infoByScale[e[0]].level}scaleToZoom(t){return this.tileInfo.scaleToZoom(t)}zoomToScale(t){return this.tileInfo.zoomToScale(t)}_getTileIdAtLOD(t,e,i){const s=this._infoByLevel[i.level];return t.set(i),e.resolution<s.resolution?null:(e.resolution===s.resolution||(t.level=e.level,t.col=Math.floor(i.col*s.resolution/e.resolution+.01),t.row=Math.floor(i.row*s.resolution/e.resolution+.01)),t)}};function Tt(o,t){return o.length=0,t.forEach(e=>o.push(e)),o}const H=new Set,N=[],R=new Map,it=[0,0];let b=class extends at{constructor(t){super(t),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:t,process:e,strategy:i}=this;this._queue=new xt({concurrency:t,process:(s,r)=>{const n=this._keyToItem.get(s);return e(n,{signal:r})},peeker:i==="scale-first"?s=>this._peekByScaleFirst(s):s=>this._peekByCenterFirst(s)})}destroy(){this.clear(),this._queue=dt(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}abort(t){const e=typeof t=="string"?t:t.id;this._queue.abort(e)}clear(){this._queue.clear(),this._keyToItem.clear()}has(t){return typeof t=="string"?this._keyToItem.has(t):this._keyToItem.has(t.id)}isOngoing(t){const e=typeof t=="string"?t:t.id;return this.has(e)&&this._queue.isOngoing(e)}pause(){this._queue.pause()}push(t){const e=t.key.id;if(this._queue.has(e))return this._queue.get(e);const i=this._queue.push(e),s=()=>{this._keyToItem.delete(e)};return this._keyToItem.set(e,t),i.then(s,s),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(t){if(!this.state)return t.values().next().value;const e=this.tileInfoView;let i=Number.NEGATIVE_INFINITY,s=Number.POSITIVE_INFINITY;t.forEach(c=>{const u=this._keyToItem.get(c),f=this.tileInfoView.getTileScale(u.key);R.has(f)||(R.set(f,[]),i=Math.max(f,i),s=Math.min(f,s)),R.get(f).push(u.key),H.add(f)});let r=this.state.scale;R.has(r)||(Tt(N,H),N.sort((c,u)=>c-u),r=N.reduce((c,u)=>Math.abs(u-r)<Math.abs(c-r)?u:c,N[0])),r=Math.min(r,i),r=Math.max(r,s);const n=R.get(r),l=e.getClosestInfoForScale(r),h=l.getColumnForX(this.state.center[0]),a=l.getRowForY(this.state.center[1]);return n.sort((c,u)=>{const f=l.denormalizeCol(c.col,c.world),g=l.denormalizeCol(u.col,u.world);return Math.sqrt((h-f)*(h-f)+(a-c.row)*(a-c.row))-Math.sqrt((h-g)*(h-g)+(a-u.row)*(a-u.row))}),H.clear(),R.clear(),n[0].id}_peekByCenterFirst(t){if(!this.state)return t.values().next().value;const e=this.tileInfoView,i=this.state.center;let s,r=Number.POSITIVE_INFINITY;return t.forEach(n=>{const l=this._keyToItem.get(n);e.getTileCoords(it,l.key);const h=vt(it,i);h<r&&(r=h,s=l.key)}),s.id}};I([B({constructOnly:!0})],b.prototype,"concurrency",void 0),I([B({constructOnly:!0})],b.prototype,"process",void 0),I([B()],b.prototype,"state",void 0),I([B({constructOnly:!0})],b.prototype,"strategy",void 0),I([B({constructOnly:!0})],b.prototype,"tileInfoView",void 0),b=I([ht("esri.views.2d.tiling.TileQueue")],b);const Et=b;class Ct{constructor(t,e,i){this.maxSize=t,this._tileInfoView=e,this._removedFunc=i,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(t){return this._tilePerId.has(t)}get(t){return this._tilePerId.get(t)}pop(t){const e=this._tilePerId.get(t);if(!e)return;const i=e.key.level,s=this._tileKeysPerLevel[i];st(this._tilePerId,t);for(let r=0;r<s.length;r++)if(s[r].id===t){s.splice(r,1);break}return e.visible=!0,e}add(t){t.visible=!1;const e=t.key,i=e.id;if(this._tilePerId.has(i))return;this._tilePerId.set(i,t);const s=e.level;this._tileKeysPerLevel[s]||(this._tileKeysPerLevel[s]=[]),this._tileKeysPerLevel[s].push(e)}prune(t,e,i){let s=this._tilePerId.size;if(s<=this.maxSize)return;let r=this._tileKeysPerLevel.length-1;for(;s>this.maxSize&&r>=0;)r!==t&&(s=this._pruneAroundCenterTile(s,e,i,r)),r--;s>this.maxSize&&(s=this._pruneAroundCenterTile(s,e,i,t))}_pruneAroundCenterTile(t,e,i,s){const r=this._tileKeysPerLevel[s];if(!r||r.length===0)return t;const{size:n,origin:l}=this._tileInfoView.tileInfo,h=i*n[0],a=i*n[1],c=[0,0],u=[0,0];for(r.sort((f,g)=>(c[0]=l.x+h*(f.col+.5),c[1]=l.y-a*(f.row+.5),u[0]=l.x+h*(g.col+.5),u[1]=l.y-a*(g.row+.5),et(c,e)-et(u,e)));r.length>0;){const f=r.pop();if(this._removeTile(f.id),--t===this.maxSize)break}return t}_removeTile(t){const e=this._tilePerId.get(t);this._removedFunc&&e&&this._removedFunc(e),st(this._tilePerId,t)}}function st(o,t){o.delete(t)}const P=new E(0,0,0,0),C=new Map,$=[],J=[];let At=class{constructor(t){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,t.resampling!=null&&(this.resampling=t.resampling),t.cachePolicy&&(this.cachePolicy=t.cachePolicy),t.coveragePolicy&&(this.coveragePolicy=t.coveragePolicy),t.buffer!=null&&(this.buffer=t.buffer),t.cacheSize&&(this._tileCache=new Ct(t.cacheSize,this.tileInfoView,e=>{this.releaseTile(e)}))}destroy(){this.tileIndex.clear()}update(t){var m,y;const{resampling:e,tileIndex:i}=this,{scale:s,center:r,resolution:n}=t.state,{minScale:l,maxScale:h}=this.tileInfoView,a=!t.stationary&&s>this._previousScale;if(this._previousScale=s,!e&&(s>l||s<h))return this.tiles.length=0,void this.clear();const c=this.tileInfoView.getTileCoverage(t.state,this.buffer,this.resampling,this.coveragePolicy);if(!c)return this.tiles.length=0,void this.clear();const{spans:u,lodInfo:f}=c,{level:g}=f;this.tiles.length=0,i.forEach(_=>_.visible=!0);let v=0,p=0;if(u.length>0)for(const{row:_,colFrom:z,colTo:A}of u)for(let F=z;F<=A;F++){v++;const S=P.set(g,_,f.normalizeCol(F),f.getWorldForColumn(F)).id;let T=i.get(S);if(T)T.isReady?(C.set(S,T),p++):a||this._addParentTile(S,C);else{if((m=this._tileCache)!=null&&m.has(S)){if(T=this._tileCache.pop(S),this.tileIndex.set(S,T),T.isReady){C.set(S,T),p++;continue}}else T=this.acquireTile(P),this.tileIndex.set(S,T);a||this._addParentTile(S,C)}}const x=p===v;for(const[_,z]of i){if(C.has(_))continue;P.set(_);const A=this.tileInfoView.intersects(c,P),F=this.cachePolicy==="purge"?P.level!==g:P.level>g;!A||!a&&x?!F&&A||$.push(z):z.isReady?F&&this.cachePolicy==="purge"&&this._hasReadyAncestor(P,g)?$.push(z):J.push(z):F&&$.push(z)}for(const _ of J)_.isReady&&C.set(_.key.id,_);for(const _ of $)this._tileCache?this._tileCache.add(_):this.releaseTile(_),i.delete(_.key.id);for(const _ of C.values())this.tiles.push(_);for(const _ of i.values())C.has(_.key.id)||(_.visible=!1);(y=this._tileCache)==null||y.prune(g,r,n),D.pool.release(c),J.length=0,$.length=0,C.clear()}clear(){const{tileIndex:t}=this;for(const e of t.values())this.releaseTile(e);t.clear()}refresh(t){var e;for(const i of this.tileIndex.values())this.tiles.includes(i)?t(i):$.push(i);for(const i of $)this.releaseTile(i),this.tileIndex.delete(i.key.id);(e=this._tileCache)==null||e.clear()}updateCacheSize(t){this._tileCache&&(this._tileCache.maxSize=t)}_addParentTile(t,e){var r;let i=t,s=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(s=this.tileIndex.get(i),s==null?void 0:s.isReady){e.has(s.key.id)||e.set(s.key.id,s);break}}else if((r=this._tileCache)!=null&&r.has(i)&&(s=this._tileCache.pop(i),this.tileIndex.set(i,s),s==null?void 0:s.isReady)){e.has(s.key.id)||e.set(s.key.id,s);break}}_hasReadyAncestor(t,e){const i=G();this.tileInfoView.getTileBounds(i,t,!0);for(const s of this.tileIndex.values())if(s.isReady&&s.key.level>=e&&s.key.level<t.level){const r=G();if(this.tileInfoView.getTileBounds(r,s.key,!0),gt(r,i))return!0}return!1}};function tt(o,t){if(!(this instanceof tt))return new tt(o,t);this._maxEntries=Math.max(4,o||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&(typeof t=="function"?this.toBBox=t:this._initFormat(t)),this.clear()}function Ft(o,t,e){if(!e)return t.indexOf(o);for(var i=0;i<t.length;i++)if(e(o,t[i]))return i;return-1}function L(o,t){q(o,0,o.children.length,t,o)}function q(o,t,e,i,s){s||(s=O(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(var r,n=t;n<e;n++)r=o.children[n],V(s,o.leaf?i(r):r);return s}function V(o,t){return o.minX=Math.min(o.minX,t.minX),o.minY=Math.min(o.minY,t.minY),o.maxX=Math.max(o.maxX,t.maxX),o.maxY=Math.max(o.maxY,t.maxY),o}function ot(o,t){return o.minX-t.minX}function rt(o,t){return o.minY-t.minY}function Q(o){return(o.maxX-o.minX)*(o.maxY-o.minY)}function j(o){return o.maxX-o.minX+(o.maxY-o.minY)}function Yt(o,t){return(Math.max(t.maxX,o.maxX)-Math.min(t.minX,o.minX))*(Math.max(t.maxY,o.maxY)-Math.min(t.minY,o.minY))}function bt(o,t){var e=Math.max(o.minX,t.minX),i=Math.max(o.minY,t.minY),s=Math.min(o.maxX,t.maxX),r=Math.min(o.maxY,t.maxY);return Math.max(0,s-e)*Math.max(0,r-i)}function Z(o,t){return o.minX<=t.minX&&o.minY<=t.minY&&t.maxX<=o.maxX&&t.maxY<=o.maxY}function W(o,t){return t.minX<=o.maxX&&t.minY<=o.maxY&&t.maxX>=o.minX&&t.maxY>=o.minY}function O(o){return{children:o,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function nt(o,t,e,i,s){for(var r,n=[t,e];n.length;)(e=n.pop())-(t=n.pop())<=i||(r=t+Math.ceil((e-t)/i/2)*i,wt(o,r,t,e,s),n.push(t,r,r,e))}tt.prototype={all:function(){return this._all(this.data,[])},search:function(o){var t=this.data,e=[],i=this.toBBox;if(!W(o,t))return e;for(var s,r,n,l,h=[];t;){for(s=0,r=t.children.length;s<r;s++)n=t.children[s],W(o,l=t.leaf?i(n):n)&&(t.leaf?e.push(n):Z(o,l)?this._all(n,e):h.push(n));t=h.pop()}return e},collides:function(o){var t=this.data,e=this.toBBox;if(!W(o,t))return!1;for(var i,s,r,n,l=[];t;){for(i=0,s=t.children.length;i<s;i++)if(r=t.children[i],W(o,n=t.leaf?e(r):r)){if(t.leaf||Z(o,n))return!0;l.push(r)}t=l.pop()}return!1},load:function(o){if(!o||!o.length)return this;if(o.length<this._minEntries){for(var t=0,e=o.length;t<e;t++)this.insert(o[t]);return this}var i=this._build(o.slice(),0,o.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var s=this.data;this.data=i,i=s}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(o){return o!=null&&this._insert(o,this.data.height-1),this},clear:function(){return this.data=O([]),this},remove:function(o,t){if(o==null)return this;for(var e,i,s,r,n=this.data,l=this.toBBox(o),h=[],a=[];n||h.length;){if(n||(n=h.pop(),i=h[h.length-1],e=a.pop(),r=!0),n.leaf&&(s=Ft(o,n.children,t))!==-1)return n.children.splice(s,1),h.push(n),this._condense(h),this;r||n.leaf||!Z(n,l)?i?(e++,n=i.children[e],r=!1):n=null:(h.push(n),a.push(e),e=0,i=n,n=n.children[0])}return this},toBBox:function(o){return o},compareMinX:ot,compareMinY:rt,toJSON:function(){return this.data},fromJSON:function(o){return this.data=o,this},_all:function(o,t){for(var e=[];o;)o.leaf?t.push.apply(t,o.children):e.push.apply(e,o.children),o=e.pop();return t},_build:function(o,t,e,i){var s,r=e-t+1,n=this._maxEntries;if(r<=n)return L(s=O(o.slice(t,e+1)),this.toBBox),s;i||(i=Math.ceil(Math.log(r)/Math.log(n)),n=Math.ceil(r/Math.pow(n,i-1))),(s=O([])).leaf=!1,s.height=i;var l,h,a,c,u=Math.ceil(r/n),f=u*Math.ceil(Math.sqrt(n));for(nt(o,t,e,f,this.compareMinX),l=t;l<=e;l+=f)for(nt(o,l,a=Math.min(l+f-1,e),u,this.compareMinY),h=l;h<=a;h+=u)c=Math.min(h+u-1,a),s.children.push(this._build(o,h,c,i-1));return L(s,this.toBBox),s},_chooseSubtree:function(o,t,e,i){for(var s,r,n,l,h,a,c,u;i.push(t),!t.leaf&&i.length-1!==e;){for(c=u=1/0,s=0,r=t.children.length;s<r;s++)h=Q(n=t.children[s]),(a=Yt(o,n)-h)<u?(u=a,c=h<c?h:c,l=n):a===u&&h<c&&(c=h,l=n);t=l||t.children[0]}return t},_insert:function(o,t,e){var i=this.toBBox,s=e?o:i(o),r=[],n=this._chooseSubtree(s,this.data,t,r);for(n.children.push(o),V(n,s);t>=0&&r[t].children.length>this._maxEntries;)this._split(r,t),t--;this._adjustParentBBoxes(s,r,t)},_split:function(o,t){var e=o[t],i=e.children.length,s=this._minEntries;this._chooseSplitAxis(e,s,i);var r=this._chooseSplitIndex(e,s,i),n=O(e.children.splice(r,e.children.length-r));n.height=e.height,n.leaf=e.leaf,L(e,this.toBBox),L(n,this.toBBox),t?o[t-1].children.push(n):this._splitRoot(e,n)},_splitRoot:function(o,t){this.data=O([o,t]),this.data.height=o.height+1,this.data.leaf=!1,L(this.data,this.toBBox)},_chooseSplitIndex:function(o,t,e){var i,s,r,n,l,h,a,c;for(h=a=1/0,i=t;i<=e-t;i++)n=bt(s=q(o,0,i,this.toBBox),r=q(o,i,e,this.toBBox)),l=Q(s)+Q(r),n<h?(h=n,c=i,a=l<a?l:a):n===h&&l<a&&(a=l,c=i);return c},_chooseSplitAxis:function(o,t,e){var i=o.leaf?this.compareMinX:ot,s=o.leaf?this.compareMinY:rt;this._allDistMargin(o,t,e,i)<this._allDistMargin(o,t,e,s)&&o.children.sort(i)},_allDistMargin:function(o,t,e,i){o.children.sort(i);var s,r,n=this.toBBox,l=q(o,0,t,n),h=q(o,e-t,e,n),a=j(l)+j(h);for(s=t;s<e-t;s++)r=o.children[s],V(l,o.leaf?n(r):r),a+=j(l);for(s=e-t-1;s>=t;s--)r=o.children[s],V(h,o.leaf?n(r):r),a+=j(h);return a},_adjustParentBBoxes:function(o,t,e){for(var i=e;i>=0;i--)V(t[i],o)},_condense:function(o){for(var t,e=o.length-1;e>=0;e--)o[e].children.length===0?e>0?(t=o[e-1].children).splice(t.indexOf(o[e]),1):this.clear():L(o[e],this.toBBox)},_initFormat:function(o){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(o[0])),this.compareMinY=new Function("a","b",t.join(o[1])),this.toBBox=new Function("a","return {minX: a"+o[0]+", minY: a"+o[1]+", maxX: a"+o[2]+", maxY: a"+o[3]+"};")}};class ft{constructor(t,e){this.key=new E(0,0,0,0),this.bounds=G(),this.objectIds=new Set,this.key.set(e);const i=t.getLODInfoAt(this.key);this.tileInfoView=t,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=i.resolution,this.level=i.level,this.scale=i.scale,this.minScale=t.zoomToScale(i.level-1),this.maxScale=t.zoomToScale(i.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return pt.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(t){return{$view:{scale:this.scale,timeZone:t}}}createChildTiles(){const t=this.key.getChildKeys(),e=yt.acquire();for(let i=0;i<t.length;i++)e[i]=new ft(this.tileInfoView,t[i]);return e}getQuantizationParameters(){return _t.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}let X=class extends at{constructor(){super(...arguments),this.color=new U([0,255,255]),this.haloOpacity=1,this.fillOpacity=.25,this.multiHighlightEnabled=!1}equals(o){return this.color.equals(o.color)&&(this.haloColor||this.color).equals(o.haloColor||o.color)&&this.haloOpacity===o.haloOpacity&&this.fillOpacity===o.fillOpacity&&this.multiHighlightEnabled===o.multiHighlightEnabled}};I([B({type:U})],X.prototype,"color",void 0),I([B({type:U})],X.prototype,"haloColor",void 0),I([B()],X.prototype,"haloOpacity",void 0),I([B()],X.prototype,"fillOpacity",void 0),I([B()],X.prototype,"multiHighlightEnabled",void 0),X=I([ht("esri.views.2d.support.HighlightOptions")],X);const jt=X;export{Ot as h,tt as i,Et as m,ft as n,jt as p,At as r,D as s};
