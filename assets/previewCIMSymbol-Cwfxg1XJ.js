import{gT as D,gU as j,gV as F,b_ as G}from"./index-DMEurr7E.js";import{e as x,a as k,K as q}from"./CIMSymbolHelper-BoGn18oF.js";import{i as T}from"./CIMResourceManager-DczA7l4l.js";import{t as L,l as U}from"./utils-CLfYlpih.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-Drr-pEDj.js";import"./GeometryUtils-Dnppy3ok.js";import"./enums-BRXbslMp.js";import"./definitions-Y_v3njP4.js";import"./mat2df32-B1Sz8eMK.js";import"./vec2-RO8L90HL.js";import"./vec2f32-BbH2jxlN.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./imageUtils-DYeyySYL.js";import"./utils-BcxqA3UU.js";import"./jsxFactory-Dbh2W5vk.js";import"./webStyleSymbolUtils-dFgP4Hkh.js";import"./Basemap-B_JFXx5r.js";import"./writeUtils-UNPMbZhD.js";import"./utils-SZYubEOl.js";const A=96/72;class K{constructor(i){this._spatialReference=i,this._imageDataCanvas=null,this._cimResourceManager=new T}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(i,s,r,o,a,t,l,y,v){if(!i)return null;const{data:g}=i;if(!g||g.type!=="CIMSymbolReference"||!g.symbol)return null;const{symbol:C}=g;t||(t=D(C));const h=await j.resolveSymbolOverrides(g,s,this._spatialReference,a,t,l,y),p=this._cimResourceManager,d=[];x.fetchResources(h,p,d),x.fetchFonts(h,p,d),d.length>0&&await Promise.all(d);const{width:n,height:c}=r,M=O(t,n,c,o),e=x.getEnvelope(h,M,p);if(!e)return null;let m=1,R=0,I=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let w=1;e.width>n&&(w=n/e.width);let b=1;e.height>c&&(b=c/e.height),o==="preview"&&(e.width<n&&(w=n/e.width),e.height<c&&(b=c/e.height)),m=Math.min(w,b),R=e.x+e.width/2,I=e.y+e.height/2}break;case"CIMLineSymbol":{(v||e.height>c)&&(m=c/e.height),I=e.y+e.height/2;const w=e.x*m+n/2,b=(e.x+e.width)*m+n/2,{paths:S}=M;S[0][0][0]-=w/m,S[0][2][0]-=(b-n)/m}break;case"CIMPolygonSymbol":{R=e.x+e.width/2,I=e.y+e.height/2;const w=e.x*m+n/2,b=(e.x+e.width)*m+n/2,S=e.y*m+c/2,z=(e.y+e.height)*m+c/2,{rings:f}=M;w<0&&(f[0][0][0]-=w,f[0][3][0]-=w,f[0][4][0]-=w),S<0&&(f[0][0][1]+=S,f[0][1][1]+=S,f[0][4][1]+=S),b>n&&(f[0][1][0]-=b-n,f[0][2][0]-=b-n),z>c&&(f[0][2][1]+=z-c,f[0][3][1]+=z-c)}}const E={type:"cim",data:{type:"CIMSymbolReference",symbol:h}};return this.rasterize(E,n,c,R,I,m,t,1,M)}rasterize(i,s,r,o,a,t,l,y=0,v=null){const{data:g}=i;if(!g||g.type!=="CIMSymbolReference"||!g.symbol)return null;const{symbol:C}=g,h=this._canvas,p=(window.devicePixelRatio||1)*A;h.width=s*p,h.height=r*p,l||(l=D(C)),v||(v=O(l,s,r,"legend")),h.width+=2*y,h.height+=2*y;const d=h.getContext("2d",{willReadFrequently:!0}),n=q.createIdentity();return n.translate(-o,-a),n.scale(t*p,-t*p),n.translate(s*p/2+y,r*p/2+y),d.clearRect(0,0,h.width,h.height),new k(d,this._cimResourceManager,n,!0).drawSymbol(C,v),d.getImageData(0,0,h.width,h.height)}}function O(u,i,s,r){const a=-i/2+1,t=i/2-1,l=s/2-1,y=-s/2+1;switch(u){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[t,0]]]};default:return r==="legend"?{rings:[[[a,l],[t,0],[t,y],[a,y],[a,l]]]}:{rings:[[[a,l],[t,l],[t,y],[a,y],[a,l]]]}}}const _=new K(null),P=F(L.size),V=F(L.maxSize),$=F(L.lineWidth),W=1;async function B(u,i,s){const r=i==null?void 0:i.size;let o=r!=null&&typeof r=="object"&&"width"in r?r.width:r,a=r!=null&&typeof r=="object"&&"height"in r?r.height:r;if(o==null||a==null)if(s==="esriGeometryPolygon")o=P,a=P;else{const t=await H(u,i,s);t&&(o=t.width,a=t.height),s==="esriGeometryPolyline"&&(o=$),o=o!=null&&isFinite(o)?Math.min(o,V):P,a=a!=null&&isFinite(a)?Math.max(Math.min(a,V),W):P}return i.style==="legend"&&s==="esriGeometryPolyline"&&(o=$),{width:o,height:a}}async function H(u,i,s){const{feature:r,fieldMap:o,viewParams:a}=i.cimOptions||i,t=await j.resolveSymbolOverrides(u.data,r,null,o,s,null,a);if(!t)return null;(u=u.clone()).data={type:"CIMSymbolReference",symbol:t},u.data.primitiveOverrides=void 0;const l=[];return x.fetchResources(t,_.resourceManager,l),x.fetchFonts(t,_.resourceManager,l),l.length>0&&await Promise.all(l),x.getEnvelope(t,null,_.resourceManager)}async function pe(u,i={}){var R;const{node:s,opacity:r,symbolConfig:o}=i,a=o!=null&&typeof o=="object"&&"isSquareFill"in o&&o.isSquareFill,t=i.cimOptions||i,l=t.geometryType||D((R=u==null?void 0:u.data)==null?void 0:R.symbol),y=await B(u,i,l),{feature:v,fieldMap:g}=t,C=a||l!=="esriGeometryPolygon"?"preview":"legend",h=await _.rasterizeCIMSymbolAsync(u,v,y,C,g,l,null,t.viewParams,t.allowScalingUp);if(!h)return null;const{width:p,height:d}=h,n=document.createElement("canvas");n.width=p,n.height=d,n.getContext("2d").putImageData(h,0,0);const c=G(y.width),M=G(y.height),e=new Image(c,M);e.src=n.toDataURL(),e.ariaLabel=i.ariaLabel??null,e.alt=i.ariaLabel??"",r!=null&&(e.style.opacity=`${r}`);let m=e;if(i.effectView!=null){const I={shape:{type:"image",x:0,y:0,width:c,height:M,src:e.src},fill:null,stroke:null,offset:[0,0]};m=U([[I]],[c,M],{effectView:i.effectView,ariaLabel:i.ariaLabel})}return s&&m&&s.appendChild(m),m}export{pe as previewCIMSymbol};
